<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <script>

        var image = document.querySelector("img");                 //获取到验证码图片
        var canvas = document.createElement('canvas');                        //新建一个canvas
        var ctx = canvas.getContext("2d");                                    //获取2D上下文
        var numbers = [];                                                     //存储数字模板的数组
        canvas.width = image.width;                                           //设置canvas的宽度
        canvas.height = image.height;                                         //设置canvas的高度
        document.body.appendChild(canvas);                                    //将canvas添加进文档
        ctx.drawImage(image, 0, 0);                                           //将验证码绘制到canvas上
        for (var i = 0; i < 4; i++) {                                         //循环四次,识别四个数字
            var pixels = ctx.getImageData(13 * i + 7, 3, 9, 16).data;         //按照公式获取到每个数字上的像素点
            var ldString = "";                                                //用来存储明暗值的字符串
            for (var j = 0, length = pixels.length; j < length; j += 4) {                 //每次循环取四个值,分别是一个像素点的r,g,b,a值
                ldString = ldString + (+(pixels[j] * 0.3 + pixels[j + 1] * 0.59 + pixels[j + 2] * 0.11 >= 128));     //灰度化+二值化,但我们并没有真正的处理图像
            }
            console.log(ldString);                 //输出存储着明暗值的字符串
        }


        var numbers = [ //模板,依次是0-9十个数字对应的明暗值字符串
            "100000011000100001001110001001110001011110001011110001011110001011110001010000011011100011000000111000010111111111111111101111111111111111101111",
            "000000111000000111111000111010001111110001111110001111110001111110001111110001111100011111000000011000000011111111111111111111111111111111111101",
            "111110111000001111000001101110000111111000111110001111110001111100011111001111111011111111111111111111111111000011110000011110111101111111011111",
            "110110000101100000111101111111110110111111110111100000111100000111111100111111110111101110100111100110000000111000001101111111111111111111111111",
            "111111111111111110111111100111111000111010000111100100011001000110011000100111000001111000000000000000000000111100001111110001111110000111111111",
            "000000001001111111001011111000001101000000111111000011111100011111100011111000011111000101000001111000011111111111111111111111111111111011111011",
            "111111111111111111111100000111000000110000111100011111000011111000110001000000000000011000000111100000111100000111000100000001110000010111111111",
            "111111111111111111110000000100000000111001110111111110111111100111111001111110011111100011111100111111001111110001111110011111100011111111111111",
            "111111111000000110000001111011000111011000111010001111000001111000011111100001111110000111111000111110001111000011111000011111111111111111111111",
            "000000001001110001001111001001110001000100001000000001000010001111100001111100011111000111000001011000011111111111111110111111101111111111111111"
        ];

    </script>

    <script>

        var image = document.querySelector("img");       //如果要用在greasemonkey脚本里,可以把下面的代码放在image的onload事件里
        var canvas = document.createElement('canvas');
        var ctx = canvas.getContext("2d");
        var numbers = [ //模板,依次是0-9十个数字对应的明暗值字符串
            "100000011000100001001110001001110001011110001011110001011110001011110001010000011011100011000000111000010111111111111111101111111111111111101111",
            "000000111000000111111000111010001111110001111110001111110001111110001111110001111100011111000000011000000011111111111111111111111111111111111101",
            "111110111000001111000001101110000111111000111110001111110001111100011111001111111011111111111111111111111111000011110000011110111101111111011111",
            "110110000101100000111101111111110110111111110111100000111100000111111100111111110111101110100111100110000000111000001101111111111111111111111111",
            "111111111111111110111111100111111000111010000111100100011001000110011000100111000001111000000000000000000000111100001111110001111110000111111111",
            "000000001001111111001011111000001101000000111111000011111100011111100011111000011111000101000001111000011111111111111111111111111111111011111011",
            "111111111111111111111100000111000000110000111100011111000011111000110001000000000000011000000111100000111100000111000100000001110000010111111111",
            "111111111111111111110000000100000000111001110111111110111111100111111001111110011111100011111100111111001111110001111110011111100011111111111111",
            "111111111000000110000001111011000111011000111010001111000001111000011111100001111110000111111000111110001111000011111000011111111111111111111111",
            "000000001001110001001111001001110001000100001000000001000010001111100001111100011111000111000001011000011111111111111110111111101111111111111111"

        ];
       
        var captcha = ""; //存放识别后的验证码
        canvas.width = image.width;
        canvas.height = image.height;
        document.body.appendChild(canvas);
        ctx.drawImage(image, 0, 0);
        for (var i = 0; i < 4; i++) {
            var pixels = ctx.getImageData(13 * i + 7, 3, 9, 16).data;
            var ldString = "";
            for (var j = 0, length = pixels.length; j < length; j += 4) {
                ldString = ldString + (+(pixels[j] * 0.3 + pixels[j + 1] * 0.59 + pixels[j + 2] * 0.11 >= 140));
            }
            var comms = numbers.map(function(value) { //为了100%识别率,这里不能直接判断是否和模板字符串相等,因为可能有个别0被计算成1,或者相反
                return ldString.split("").filter(function(v, index) {
                    return value[index] === v
                }).length
            });
            captcha += comms.indexOf(Math.max.apply(null, comms)); //添加到识别好的验证码中
        }
        console.log(captcha);

    </script>

</head>
<body>

</body>
</html>
<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <script>

        var image = document.querySelector("img");                 //获取到验证码图片
        var canvas = document.createElement('canvas');                        //新建一个canvas
        var ctx = canvas.getContext("2d");                                    //获取2D上下文
        var numbers = [];                                                     //存储数字模板的数组
        canvas.width = image.width;                                           //设置canvas的宽度
        canvas.height = image.height;                                         //设置canvas的高度
        document.body.appendChild(canvas);                                    //将canvas添加进文档
        ctx.drawImage(image, 0, 0);                                           //将验证码绘制到canvas上
        for (var i = 0; i < 4; i++) {

            var pixels = ctx.getImageData(15 * i + 3, 2, 10, 18).data;


            //按照公式获取到每个数字上的像素点
            var ldString = "";                                                //用来存储明暗值的字符串
            for (var j = 0, length = pixels.length; j < length; j += 4) {                 //每次循环取四个值,分别是一个像素点的r,g,b,a值
                ldString = ldString + (+(pixels[j] * 0.3 + pixels[j + 1] * 0.59 + pixels[j + 2] * 0.11 >= 128));     //灰度化+二值化,但我们并没有真正的处理图像
            }
            console.log(ldString);                 //输出存储着明暗值的字符串
        }


        var numbers = [ //模板,依次是0-9十个数字对应的明暗值字符串
            "111111111111111111111111000011011000000111000110001000111000100011100000011110000001111000000111100000011110000001110001000111000110000000111100001111111101111111111111111111011111",
            "111111111111111110111111100011100000001101000000111111100011111100011011100001111111000111111100011110110001111111000111111000111100000000010000000001111111111111111111111101111111",
            "111111111111111111111100000011100000000110111100001111111000111111000101110100011101100011111100111111000011111001111111000111111100000000110000000010111111111111011111111111111111",
            "111111111011111111111110000011110000000111011110001110011000111111000111000000111100000111111110001101111100001111000001010110001100000000111000001111111111111111110101111110111111",
            "111111111111101110111111111000111111000011110000000111001000111001000111001100011001110001001111000100000000000000000000111110001111111000111111000011111111111111111111111111111111",
            "111111111110111111111100000000100000000011001111111100101101100000011010000000111111100001111011000111111100011011100001011110001100000001111000001111111111111011111110111111111111",
            "110111111111111111111111000001111000000011000011101000111110100011101100011000110000000001000001000000011110000000111000000111000110000000111100000111111111111111111111111110111111",
            "111111111111111111111000000000110000000011111111001111111100111111100110111100111111100111111100001111110011111110011111110001111111001111011000111111111111111111111111011111111111",
            "110111111111011011110011000001111000000100000110001100011000110001000111000000111100000011100010000100011100000001111000000111000100000000111000000111111111111111111111111111111111",
            "111111111111111101111111000011110000000010001110001000111100000011100010001110001000000000110000100011111100001111110001011110001100000001111000001111110111111111111111111111111011"
        ];

    </script>


    <!--http://www.jimei.cn/safecode-->
    <script>
        var iframe = document.createElement('iframe');
        iframe.src="about:blank";
        iframe.width="1000px";
        iframe.height="500px";
        document.body.appendChild(iframe);
        setInterval(function () {
            var image = new Image();
            //var image = document.querySelector("img");
            image.src = "http://" + document.domain + "/safecode?d" + new Date();
            /* document.body.innerHTML = "";
             document.body.appendChild(image);*/
            var captcha = ""; //存放识别后的验证码
            image.onload = function () {
                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext("2d");
                var numbers_1 = [ //模板,依次是0-9十个数字对应的明暗值字符串
                    "111111111111111111111111000011011000000111000110001000111000100011100000011110000001111000000111100000011110000001110001000111000110000000111100001111111101111111111111111111011111",
                    "111111111111111110111111100011100000001101000000111111100011111100011011100001111111000111111100011110110001111111000111111000111100000000010000000001111111111111111111111101111111",
                    "111111111111111111111100000011100000000110111100001111111000111111000101110100011101100011111100111111000011111001111111000111111100000000110000000010111111111111011111111111111111",
                    "111111111011111111111110000011110000000111011110001110011000111111000111000000111100000111111110001101111100001111000001010110001100000000111000001111111111111111110101111110111111",
                    "111111111111101110111111111000111111000011110000000111001000111001000111001100011001110001001111000100000000000000000000111110001111111000111111000011111111111111111111111111111111",
                    "111111111110111111111100000000100000000011001111111100101101100000011010000000111111100001111011000111111100011011100001011110001100000001111000001111111111111011111110111111111111",
                    "110111111111111111111111000001111000000011000011101000111110100011101100011000110000000001000001000000011110000000111000000111000110000000111100000111111111111111111111111110111111",
                    "111111111111111111111000000000110000000011111111001111111100111111100110111100111111100111111100001111110011111110011111110001111111001111011000111111111111111111111111011111111111",
                    "110111111111011011110011000001111000000100000110001100011000110001000111000000111100000011100010000100011100000001111000000111000100000000111000000111111111111111111111111111111111",
                    "111111111111111101111111000011110000000010001110001000111100000011100010001110001000000000110000100011111100001111110001011110001100000001111000001111110111111111111111111111111011"
                ];
                var numbers_2 = [ //模板,依次是0-9十个数字对应的明暗值字符串
                    "110100001111100000011100011000100011100010001110000001111000000111100000011110000001111000000111000100011100011000000011110000111111111111110111111111111111100111111111111111111111",
                    "111110001111000000111100000011111110001111110001111111000110111000011101100001101111000111111100011111100011110000000001000000000111111111111111111111111111011111111111111111111111",
                    "110000001110000000011011110000111111100011111000011111110001111110001111110011101100011111100111111100011111110000000011000000001111111111111110111111111111111111111111111111111111",
                    "111000001111000000011101111000111111100011111100011100000011110000011111011000111111110001111111000101111000110000000011100000111111111111111111111111111111111111111111101111111110",
                    "111111100011110100001111000000111100100011100100011100110001100111000100111100010000000000000000000011110000111111100011111110001111111110111111111011111111111111011111111111111111",
                    "110000000011000000001100111111010011110110000001111000000011111010000111111100011111110001111110000101110000110000000011100000111111111111111111111111111111111111111111111111111111",
                    "011100000111100000001100001110100011111110001111110001100011000000000100001100000001111000000111100000011100011000000011110000011110111111111111110111111110111111111111111011111111",
                    "010000000011000000001111111100111111110001111110011111010011111110011111110001111111001111111001111111000111111100111111100011111111111110111111111111110111111111111111111111111011",
                    "111100000111100000011100011000110001100011000100011100000011110000001110001000010001110000000111100000011100010000000011100000011111111111011111111011111111111111111111101111111101",
                    "111100001111000000001000111000100011110010001110001000111000100000000011000010001101100000111111000101111000010000000111100000111111101111111111101111111111111111111111110111111111"
                ];
                var numbers_3 = [ //模板,依次是0-9十个数字对应的明暗值字符串
                    "110111111111111111111111111111111100001111100000011100011000100001100010001110000001111000000011100000011110000001111000000111000100011100011000000011110000111111011111111111111111",
                    "111111111111101111111111111111111110001101000000111100000010111110001111110001111111000111111100011111110001111111000101111100011110100011110000000000000000000111111011111111111111",
                    "111111111111111111111111111111110000001100000000011011110000111101100011111000010111110001111100001111110010111100011101100111111100001111100000000011000000001111111111111111111111",
                    "111111111111111111111111111110111000001111000000011001111000111111100011111100010100000011010000011011111000111111110001111111000101111000110000000010100000111111111111111111111101",
                    "111111111111111111111111111111111111100011111100001111100000111100100011100100011100110001100101000100111100010000000000000000000011111000111111100011111110001110111111111111111111",
                    "011111111111111111111111111111110000000011000000001100111111110011111110000001111000000011111110000111111100011110110001111110000101111000110000000111100000101101111111111111111111",
                    "111111111111111111111111111111111000000111100000001100001110100011111110001111110001000011000000000100001100000001111000000111100000011100011000000011100000001111111111111111111111",
                    "111111111110111111111111111111110000000011000000001111111100011111110010110110011110110010111110011111110001110101001111111001111111000111111100111111100011111111111111111111101111",
                    "111111111111111111111111111111111100000111100000011100011000110001100011000100011100000011110000001110001000010001110000000011100000011100010000000011000000011111111110111111110111",
                    "111111111111111111111111111111111100001111000000001000111000100011010010001110001000111000100000000011000010001111110000111111000101111000110000000011100000111111101111111111111111"
                ];
                var numbers_4 = [ //模板,依次是0-9十个数字对应的明暗值字符串
                    "111111111101110000111110000001100001100010001100001000111000000111100000011110000001111000000111100000011100010001110001100000001111000011111011111111011111111111111111111111111111",
                    "001111111111111000111100000011110000001111111000011111000111111100011111100001111111000111111100010111110001111110001111000000000100000000011110111111111111111111111111111111111111",
                    "111111111111000000101000000001101111000011111110001111110001111111000111111000111111000111110001111110011111110001111111000000001100000000111111111111111111011111111111111111111111",
                    "111111111111100000111100000001110111100011111110001111110001110000001110000001110111100011111011000111111100010111100011000000001110000001111111111111111110111111111111011110111111",
                    "111111111111111110001111110000111110000011110010001110000001110011000110011100010011110001000000000000000000001111100011111110001111111000111111111011111111111111111111111111111101",
                    "111111111111000000001100000000110011111111001110111000000111000000001111111000011111110001101110000111111000010111100011000000010100000011111011101111111111111111111111111111111111",
                    "111111011111110000011110000000010000111010001111111000111111000100001100000000010000110000000111100000011110000001110001100000001111000001111111011111111111111111111111111111111111",
                    "111111111111000000001100000000111110110011111111001111111001111111001111111001111110000111111100111111100111111100011111110011111110001111111111111111111101110111110111011111110111",
                    "111011111111110000011110000001110001100011000110001100010001110000001111000000111000100001000111000000011110000001110001000000001110000001111111111111111111111100111111111111111111",
                    "101111111111110000111100000000100011100010001111001000011000100011100010000000001100001000111111000011111100010111100011000000011110000011111111111111111111111111111111111011111111"
                ];

                canvas.width = image.width;
                canvas.height = image.height;
                //document.body.appendChild(canvas);
                ctx.drawImage(image, 0, 0);
                for (var i = 0; i < 4; i++) {
                    var numbers = null;
                    if (i == 0) {
                        numbers = numbers_1;
                    }
                    if (i == 1) {
                        numbers = numbers_2;
                    }
                    if (i == 2) {
                        numbers = numbers_3;
                    }
                    if (i == 3) {
                        numbers = numbers_4;
                    }
                    var pixels = ctx.getImageData(15 * i + 3, 2, 10, 18).data;
                    var ldString = "";
                    for (var j = 0, length = pixels.length; j < length; j += 4) {
                        ldString = ldString + (+(pixels[j] * 0.3 + pixels[j + 1] * 0.59 + pixels[j + 2] * 0.11 >= 140));
                    }
                    var comms = numbers.map(function (value) { //为了100%识别率,这里不能直接判断是否和模板字符串相等,因为可能有个别0被计算成1,或者相反
                        return ldString.split("").filter(function (v, index) {
                            return value[index] === v
                        }).length
                    });
                    captcha += comms.indexOf(Math.max.apply(null, comms)); //添加到识别好的验证码中
                }
                console.log(captcha);
                var url = "http://www.jimei.cn/front/order/saveorder.html?pid=d5da89b541384243a2f2c0650fe09ad6&activityProductId=4650df2d5ba3429ea5d8828ee362b397&code=" + captcha;
                //console.log("http://www.jimei.cn/front/order/saveorder.html?pid=d5da89b541384243a2f2c0650fe09ad6&activityProductId=e6e8525c754c4b90a023f497ddb1913e&code=0869");
                iframe.src=url;
            }
        }, 10);
    </script>

</head>
<body>

</body>
</html>


<div class="dialog">
    <div class="box">
        <input type="text" class="yzm" id="safecode" placeholder="图片验证码">

        <p class="yzm-pic"><img src="/safecode"></p>

        <div class="clear"></div>
        <input type="button" value="确定" class="pop-btn sure" onclick="codeQianggou()">
        <input type="button" value="取消" class="pop-btn cancel" onclick="closeCode()">
    </div>
</div>

<script>

    //验证码提交订单清沟
    function codeQianggou() {
        var code = $("#safecode").val();
        if (code == null || code == "") {
            alert("验证码不能为空！");
            return;
        }
        $.ajax({
            url: "/asyscode.html",
            data: "data=" + new Date() + "&code=" + code,
            type: "get",
            dataType: "json",
            success: function (data) {
                if (data.falg == "1") {
                    alert("请输入正确的验证码！");
                    return;
                } else {
                    $("#code").val(code);
                    //提交表单
                    $('#form').submit();
                    //隐藏验证码弹框
                    $(".validate").hide();
                    //提交特效显示
                    var progress = function ($el) {
                        var liItem = $el.find("ul li");
                        var len = liItem.size();
                        var index = 0;
                        var timer = setInterval(function () {
                            if (index % len == 0) {
                                liItem.removeClass("active");
                            }
                            liItem.eq(index).addClass("active");
                            index++;
                            index = index % len;
                        }, 500);
                    };
                    $(".schedule").show();
                    progress($(".schedule"));
                }
            }
        });
    }
</script>
